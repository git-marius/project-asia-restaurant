<!-- templates/dashboard.html -->
{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 py-6">
    <div class="flex gap-6">

        <!-- Sidebar -->
        <aside class="hidden w-64 shrink-0 lg:block">
            <div class="sticky top-6 space-y-4">
                <div>
                    <div class="text-lg font-semibold tracking-tight">Mitarbeiter-Dashboard</div>
                    <div class="mt-1 text-sm text-neutral-400">Clean UI ¬∑ Dark ¬∑ Live</div>
                </div>

                <nav class="space-y-1 rounded-2xl border border-white/10 bg-white/5 p-2">
                    <button class="nav-btn flex w-full items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium"
                        data-view="dashboard">
                        <span class="opacity-80">üìä</span> Dashboard
                    </button>
                    <button class="nav-btn flex w-full items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium"
                        data-view="regression">
                        <span class="opacity-80">üßÆ</span> Regression
                    </button>
                </nav>

                <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <div class="text-sm text-neutral-400">Letztes Update</div>
                    <div id="top-last-update" class="mt-1 text-sm font-medium text-neutral-200">‚Äì</div>

                    <button id="btnRefresh"
                        class="mt-3 w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm font-medium text-neutral-200 hover:bg-white/10">
                        Aktualisieren
                    </button>

                    <div
                        class="mt-3 inline-flex items-center gap-2 rounded-full border border-white/10 bg-black/20 px-3 py-1 text-xs text-neutral-300">
                        <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
                        Auto-Refresh 30s
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="min-w-0 flex-1">

            <!-- Topbar (mobile + allgemein) -->
            <div class="mb-5 flex flex-wrap items-end justify-between gap-3">
                <div>
                    <h1 id="viewTitle" class="text-2xl font-semibold tracking-tight">Dashboard</h1>
                </div>

                <div class="flex w-full items-center gap-2 lg:w-auto">
                    <!-- Mobile nav -->
                    <div
                        class="inline-flex w-full flex-wrap gap-1 rounded-2xl border border-white/10 bg-white/5 p-1 lg:hidden">
                        <button class="nav-btn rounded-xl px-4 py-2 text-sm font-medium"
                            data-view="dashboard">Dashboard</button>
                        <button class="nav-btn rounded-xl px-4 py-2 text-sm font-medium"
                            data-view="regression">Regression</button>
                    </div>

                    <button id="btnRefreshTop"
                        class="hidden rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm font-medium text-neutral-200 hover:bg-white/10 lg:inline-flex">
                        Aktualisieren
                    </button>
                </div>
            </div>

            <!-- ===================== VIEW: DASHBOARD ===================== -->
            <section data-panel="dashboard">
                <!-- KPIs -->
                <div class="grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-4">
                    <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <div class="text-sm text-neutral-400">Temperatur</div>
                                <div class="mt-2 text-3xl font-semibold tracking-tight" id="kpi-temp">‚Äì</div>
                                <div class="mt-2 text-sm text-neutral-400" id="kpi-ts">‚Äì</div>
                            </div>
                            <div
                                class="grid h-11 w-11 place-items-center rounded-2xl border border-white/10 bg-white/5">
                                üå°Ô∏è</div>
                        </div>
                    </div>

                    <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <div class="text-sm text-neutral-400">Luftfeuchtigkeit</div>
                                <div class="mt-2 flex items-baseline gap-2">
                                    <div class="text-3xl font-semibold tracking-tight" id="kpi-hum">‚Äì</div>
                                    <div class="text-sm text-neutral-400">%</div>
                                </div>
                                <div class="mt-2 text-sm text-neutral-400">Aktuell</div>
                            </div>
                            <div
                                class="grid h-11 w-11 place-items-center rounded-2xl border border-white/10 bg-white/5">
                                üíß</div>
                        </div>
                    </div>

                    <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <div class="text-sm text-neutral-400">VOC</div>
                                <div class="mt-2 text-3xl font-semibold tracking-tight" id="kpi-voc">‚Äì</div>
                                <div class="mt-2 text-sm text-neutral-400">ppm / raw</div>
                            </div>
                            <div
                                class="grid h-11 w-11 place-items-center rounded-2xl border border-white/10 bg-white/5">
                                üß™</div>
                        </div>
                    </div>

                    <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <div class="text-sm text-neutral-400">Personen</div>
                                <div class="mt-2 text-3xl font-semibold tracking-tight" id="kpi-people">‚Äì</div>
                                <div class="mt-2 text-sm text-neutral-400">Radar: <span id="kpi-radar">‚Äì</span></div>
                            </div>
                            <div
                                class="grid h-11 w-11 place-items-center rounded-2xl border border-white/10 bg-white/5">
                                üë•</div>
                        </div>
                    </div>
                </div>

                <!-- Main temp chart -->
                <div class="mt-3 rounded-2xl border border-white/10 bg-white/5 p-5">
                    <div class="flex flex-wrap items-baseline justify-between gap-3">
                        <div>
                            <div class="text-lg font-semibold tracking-tight">Temperaturverlauf</div>
                            <div class="mt-1 text-sm text-neutral-400">letzte 24 Stunden</div>
                        </div>
                        <div class="text-sm text-neutral-400">Line</div>
                    </div>
                    <div class="mt-4 h-[440px]">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- ===================== VIEW: REGRESSION ===================== -->
            <section data-panel="regression" hidden>
                <div class="grid grid-cols-1 gap-3 lg:grid-cols-5">
                    <!-- Chart -->
                    <div class="rounded-2xl border border-white/10 bg-white/5 p-5 lg:col-span-3">
                        <div class="flex flex-wrap items-baseline justify-between gap-3">
                            <div>
                                <div class="text-lg font-semibold tracking-tight">Personen & Temperatur</div>
                                <div class="mt-1 text-sm text-neutral-400">Scatter + Regressionslinie</div>
                            </div>
                            <div class="text-sm text-neutral-400">Regression</div>
                        </div>
                        <div class="mt-4 h-[460px]">
                            <canvas id="scatterChart"></canvas>
                        </div>
                    </div>

                    <!-- Numbers + Predictions -->
                    <div class="rounded-2xl border border-white/10 bg-white/5 p-5 lg:col-span-2">
                        <div>
                            <div class="text-lg font-semibold tracking-tight">Modell</div>
                            <div class="mt-1 text-sm text-neutral-400">Temperatur = a¬∑Personen + b</div>
                        </div>

                        <div class="mt-4 grid grid-cols-1 gap-3">
                            <div class="rounded-2xl border border-white/10 bg-black/20 p-4">
                                <div class="text-sm text-neutral-400">Steigung (a)</div>
                                <div class="mt-1 text-xl font-semibold" id="reg-a">‚Äì</div>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-black/20 p-4">
                                <div class="text-sm text-neutral-400">Intercept (b)</div>
                                <div class="mt-1 text-xl font-semibold" id="reg-b">‚Äì</div>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-black/20 p-4">
                                <div class="text-sm text-neutral-400">R¬≤</div>
                                <div class="mt-1 text-xl font-semibold" id="reg-r2">‚Äì</div>
                            </div>
                        </div>

                        <div class="mt-5 border-t border-white/10 pt-4">
                            <div class="flex items-center justify-between">
                                <div class="text-sm font-medium text-neutral-200">Vorhersagen</div>
                                <div class="text-sm text-neutral-400">0 / 60 / 120</div>
                            </div>

                            <div class="mt-3 grid grid-cols-3 gap-2">
                                <div class="rounded-2xl border border-white/10 bg-black/20 p-3 text-center">
                                    <div class="text-xs text-neutral-400">0</div>
                                    <div class="mt-1 text-base font-semibold" id="pred-0">‚Äì</div>
                                </div>
                                <div class="rounded-2xl border border-white/10 bg-black/20 p-3 text-center">
                                    <div class="text-xs text-neutral-400">60</div>
                                    <div class="mt-1 text-base font-semibold" id="pred-60">‚Äì</div>
                                </div>
                                <div class="rounded-2xl border border-white/10 bg-black/20 p-3 text-center">
                                    <div class="text-xs text-neutral-400">120</div>
                                    <div class="mt-1 text-base font-semibold" id="pred-120">‚Äì</div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </section>

        </main>
    </div>
</div>

<script>
    // ---------- Navigation / Views ----------
    const navButtons = Array.from(document.querySelectorAll('.nav-btn'))
    const panels = Array.from(document.querySelectorAll('[data-panel]'))

    const viewMeta = {
        dashboard: { title: 'Dashboard', subtitle: 'KPIs + Temperaturverlauf.' },
        regression: { title: 'Regression', subtitle: 'Scatter + Linie + Kennzahlen + Predictions.' }
    }

    let activeView = 'dashboard'
    let lastData = null

    function setActiveView(view) {
        activeView = view

        navButtons.forEach(btn => {
            const active = btn.dataset.view === view
            const base = btn.classList.contains('flex')
                ? 'nav-btn flex w-full items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium'
                : 'nav-btn rounded-xl px-4 py-2 text-sm font-medium'

            btn.className = active
                ? `${base} bg-white/10 text-white`
                : `${base} text-neutral-300 hover:bg-white/5 hover:text-white`
        })

        panels.forEach(p => p.hidden = (p.dataset.panel !== view))

        document.getElementById('viewTitle').textContent = viewMeta[view].title

        if (lastData) renderForView(view, lastData)
    }

    navButtons.forEach(btn => btn.addEventListener('click', () => setActiveView(btn.dataset.view)))
    setActiveView('dashboard')

    // ---------- Chart.js Defaults (pro, dark, clean) ----------
    function applyChartDefaults() {
        Chart.defaults.responsive = true
        Chart.defaults.maintainAspectRatio = false
        Chart.defaults.animation = false
        Chart.defaults.color = 'rgba(255,255,255,0.60)'
        Chart.defaults.font.family = 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial'
        Chart.defaults.font.size = 12

        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(10,10,10,0.92)'
        Chart.defaults.plugins.tooltip.borderColor = 'rgba(255,255,255,0.10)'
        Chart.defaults.plugins.tooltip.borderWidth = 1
        Chart.defaults.plugins.tooltip.padding = 10
        Chart.defaults.plugins.tooltip.cornerRadius = 12
        Chart.defaults.plugins.tooltip.displayColors = false

        Chart.defaults.interaction.mode = 'index'
        Chart.defaults.interaction.intersect = false
    }

    function chartPalette() {
        return {
            primary: 'rgba(56, 189, 248, 0.95)',
            primarySoft: 'rgba(56, 189, 248, 0.18)',
            gridY: 'rgba(255,255,255,0.08)',
            gridX: 'rgba(255,255,255,0.04)',
            ticks: 'rgba(255,255,255,0.55)',
        }
    }

    function makeGradient(ctx) {
        const c = chartPalette()
        const h = ctx.canvas.height || 360
        const g = ctx.createLinearGradient(0, 0, 0, h)
        g.addColorStop(0, c.primarySoft)
        g.addColorStop(1, 'rgba(56, 189, 248, 0.00)')
        return g
    }

    function sparseTicks(max = 8) {
        return function (value, index, ticks) {
            const n = ticks.length || 1
            const step = Math.ceil(n / max)
            return (index % step === 0) ? this.getLabelForValue(value) : ''
        }
    }

    // ---------- Data / KPI ----------
    let tempChart, scatterChart
    let pollTimer = null
    let inFlight = false

    const fmtTime = (iso) => new Date(iso).toLocaleString('de-DE', { hour: '2-digit', minute: '2-digit' })
    const fmtDateTime = (iso) => new Date(iso).toLocaleString('de-DE')

    async function loadDashboard(signal) {
        const res = await fetch('/api/dashboard', { cache: 'no-store', signal })
        if (!res.ok) throw new Error('API Fehler: ' + res.status)
        return await res.json()
    }

    function roundStep(value, step) { return Math.round(value / step) * step }
    function yBounds(values) {
        if (!values.length) return { min: 0, max: 1 }
        const vMin = Math.min(...values)
        const vMax = Math.max(...values)
        const pad = Math.max(0.5, (vMax - vMin) * 0.15)
        return { min: roundStep(vMin - pad, 0.5), max: roundStep(vMax + pad, 0.5) }
    }

    function setKpis(data) {
        const cur = data.current
        if (!cur) return
        document.getElementById('kpi-temp').textContent = `${cur.temperature.toFixed(1)} ¬∞C`
        document.getElementById('kpi-hum').textContent = `${cur.humidity.toFixed(1)}`
        document.getElementById('kpi-voc').textContent = `${cur.voc.toFixed(0)}`
        document.getElementById('kpi-people').textContent = `${cur.persons}`
        document.getElementById('kpi-radar').textContent = cur.radar ? 'Belegt' : 'Leer'
        document.getElementById('kpi-ts').textContent = `Letztes Update: ${fmtDateTime(cur.timestamp)}`
        document.getElementById('top-last-update').textContent = `${fmtDateTime(cur.timestamp)}`
    }

    function setRegression(data) {
        const r = data.regression || {}
        const p = data.predictions || {}
        document.getElementById('reg-a').textContent = (r.slope == null) ? '‚Äì' : r.slope.toFixed(4)
        document.getElementById('reg-b').textContent = (r.intercept == null) ? '‚Äì' : r.intercept.toFixed(2)
        document.getElementById('reg-r2').textContent = (r.r2 == null) ? '‚Äì' : r.r2.toFixed(3)

        document.getElementById('pred-0').textContent = (p.p0 == null) ? '‚Äì' : `${p.p0.toFixed(1)} ¬∞C`
        document.getElementById('pred-60').textContent = (p.p60 == null) ? '‚Äì' : `${p.p60.toFixed(1)} ¬∞C`
        document.getElementById('pred-120').textContent = (p.p120 == null) ? '‚Äì' : `${p.p120.toFixed(1)} ¬∞C`
    }

    function renderTemp(points) {
        const c = chartPalette()
        const labels = points.map(p => fmtTime(p.t))
        const values = points.map(p => p.temperature)
        const bounds = yBounds(values)

        const canvas = document.getElementById('tempChart')
        if (!canvas) return
        const ctx = canvas.getContext('2d')

        if (tempChart) tempChart.destroy()
        tempChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    data: values,
                    tension: 0.25,
                    pointRadius: 0,
                    borderWidth: 2,
                    borderColor: c.primary,
                    fill: true,
                    backgroundColor: makeGradient(ctx),
                }]
            },
            options: {
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (item) => ` ${item.parsed.y.toFixed(1)} ¬∞C` } }
                },
                scales: {
                    x: { ticks: { color: c.ticks, callback: sparseTicks(8) }, grid: { color: c.gridX, drawBorder: false }, border: { display: false } },
                    y: { min: bounds.min, max: bounds.max, ticks: { color: c.ticks }, grid: { color: c.gridY, drawBorder: false }, border: { display: false } }
                },
                elements: { line: { borderJoinStyle: 'round', borderCapStyle: 'round' } }
            }
        })
    }

    function renderScatter(points, regLine) {
        const c = chartPalette()
        const datasets = [{
            data: points,
            pointRadius: 3,
            pointHoverRadius: 5,
            backgroundColor: c.primary,
        }]

        if (Array.isArray(regLine) && regLine.length >= 2) {
            datasets.push({
                type: 'line',
                data: regLine,
                pointRadius: 0,
                tension: 0,
                borderWidth: 2,
                borderDash: [6, 5],
                borderColor: c.primary,
            })
        }

        const canvas = document.getElementById('scatterChart')
        if (!canvas) return
        const ctx = canvas.getContext('2d')

        if (scatterChart) scatterChart.destroy()
        scatterChart = new Chart(ctx, {
            type: 'scatter',
            data: { datasets },
            options: {
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (item) => ` ${item.parsed.x} Pers. ‚Üí ${item.parsed.y.toFixed(1)} ¬∞C` } }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Personenanzahl', color: c.ticks },
                        beginAtZero: true,
                        ticks: { color: c.ticks },
                        grid: { color: c.gridX, drawBorder: false },
                        border: { display: false }
                    },
                    y: {
                        title: { display: true, text: 'Temperatur (¬∞C)', color: c.ticks },
                        ticks: { color: c.ticks },
                        grid: { color: c.gridY, drawBorder: false },
                        border: { display: false }
                    }
                }
            }
        })
    }

    function renderForView(view, data) {
        const pts = data.line?.points || []
        if (view === 'dashboard') {
            renderTemp(pts)
        } else if (view === 'regression') {
            renderScatter(data.scatter?.points || [], data.regression?.line_points || [])
        }
    }

    // ---------- init / polling ----------
    async function initOnce() {
        if (inFlight) return
        inFlight = true
        const controller = new AbortController()

        try {
            const data = await loadDashboard(controller.signal)
            lastData = data

            setKpis(data)
            setRegression(data)

            renderForView(activeView, data)
        } catch (e) {
            console.error(e)
        } finally {
            inFlight = false
        }
    }

    function startPolling() {
        if (pollTimer) clearInterval(pollTimer)
        pollTimer = setInterval(() => {
            if (document.visibilityState === 'visible') initOnce()
        }, 30000)
    }

    document.getElementById('btnRefresh').addEventListener('click', initOnce)
    document.getElementById('btnRefreshTop').addEventListener('click', initOnce)

    applyChartDefaults()
    setActiveView('dashboard')
    initOnce()
    startPolling()
</script>
{% endblock %}